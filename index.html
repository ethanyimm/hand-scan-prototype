<!DOCTYPE html>
<html>
<head>
  <title>Hand Scan Prototype</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h2>Hand Scan Prototype</h2>
  <p>Upload your hand photo with a credit card or quarter for scale.</p>
  
  <div id="instructions">
    <h3>Instructions</h3>
    <ol>
      <li id="step1">Upload a hand photo with a credit card or quarter visible.</li>
      <li id="step2">Calibrate scale: drag the blue dots across the reference object.</li>
      <li id="step3">Measure fingers: drag dots to mark tip and base of index and ring fingers.</li>
      <li id="step4">View results: see finger lengths and 2D:4D ratio.</li>
    </ol>
  </div>

  <input type="file" accept="image/*" capture="environment" id="handUpload">
  
  <h3>Step 1: Calibrate Scale</h3>
  <p>Drag the blue dots across your reference object (credit card or quarter).</p>
  <select id="reference">
    <option value="credit">Credit Card (85.6 mm)</option>
    <option value="quarter">Quarter (24.26 mm)</option>
  </select>

  <div id="preview-container">
    <img id="preview"/>
    <!-- Calibration line -->
    <div id="calibLine" class="line"></div>
    <div id="calibStart" class="handle"></div>
    <div id="calibEnd" class="handle"></div>
    <!-- Index finger line -->
    <div id="indexLine" class="line"></div>
    <div id="indexStart" class="handle"></div>
    <div id="indexEnd" class="handle"></div>
    <!-- Ring finger line -->
    <div id="ringLine" class="line"></div>
    <div id="ringStart" class="handle"></div>
    <div id="ringEnd" class="handle"></div>
    <!-- Reference guide box -->
    <div id="refGuide">Place card/coin here</div>
  </div>

  <div id="results" class="result"></div>
  <button onclick="resetAll()">Reset</button>

  <script>
    const upload = document.getElementById('handUpload');
    const preview = document.getElementById('preview');
    const results = document.getElementById('results');
    let pixelToMm = 0;

    function makeDraggable(handle, line, otherHandle, isCalibration=false) {
      let dragging = false, offsetX, offsetY;

      handle.addEventListener('mousedown', (e) => {
        dragging = true;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
      });

      document.addEventListener('mouseup', () => dragging = false);

      document.addEventListener('mousemove', (e) => {
        if (!dragging) return;
        handle.style.left = (e.pageX - offsetX) + 'px';
        handle.style.top = (e.pageY - offsetY) + 'px';
        updateLine(line, handle, otherHandle, isCalibration);
      });
    }

    function updateLine(line, start, end, isCalibration=false) {
      const x1 = start.offsetLeft, y1 = start.offsetTop;
      const x2 = end.offsetLeft, y2 = end.offsetTop;
      const lengthPx = Math.sqrt((x2-x1)**2 + (y2-y1)**2);

      if (isCalibration) {
        const refType = document.getElementById('reference').value;
        const realMm = refType === 'credit' ? 85.6 : 24.26;
        pixelToMm = realMm / lengthPx;
        line.dataset.mm = realMm.toFixed(1);
      } else {
        const mm = pixelToMm > 0 ? (lengthPx * pixelToMm).toFixed(1) : (lengthPx * 0.25).toFixed(1);
        line.dataset.mm = mm;
      }

      line.style.left = x1 + 'px';
      line.style.top = y1 + 'px';
      line.style.height = lengthPx + 'px';
      line.style.transform = `rotate(${Math.atan2(y2-y1, x2-x1)}rad)`;

      updateResults();
    }

    function updateResults() {
      const index = document.getElementById('indexLine').dataset.mm || 0;
      const ring = document.getElementById('ringLine').dataset.mm || 0;
      if (index > 0 && ring > 0) {
        const ratio = (index / ring).toFixed(2);
        results.innerHTML = `
          <p>Index finger: ${index} mm</p>
          <p>Ring finger: ${ring} mm</p>
          <p>2D:4D ratio: ${ratio}</p>
          <p><em>Scale calibrated using ${document.getElementById('reference').value}</em></p>
        `;
      }
    }

    function resetAll() {
      upload.value = '';
      preview.style.display = 'none';
      preview.src = '';
      results.innerHTML = '';
      pixelToMm = 0;
    }

    upload.addEventListener('change', () => {
      const file = upload.files[0];
      if (file) {
        preview.src = URL.createObjectURL(file);
        preview.style.display = 'block';
      }
    });

    preview.onload = () => {
      const indexStart = document.getElementById('indexStart');
      const indexEnd = document.getElementById('indexEnd');
      const ringStart = document.getElementById('ringStart');
      const ringEnd = document.getElementById('ringEnd');
      const calibStart = document.getElementById('calibStart');
      const calibEnd = document.getElementById('calibEnd');
      const indexLine = document.getElementById('indexLine');
      const ringLine = document.getElementById('ringLine');
      const calibLine = document.getElementById('calibLine');

      [indexStart, indexEnd, ringStart, ringEnd, calibStart, calibEnd].forEach(h => {
        h.style.left = '150px';
        h.style.top = '150px';
      });

      makeDraggable(calibStart, calibLine, calibEnd, true);
      makeDraggable(calibEnd, calibLine, calibStart, true);
      makeDraggable(indexStart, indexLine, indexEnd, false);
      makeDraggable(indexEnd, indexLine, indexStart, false);
      makeDraggable(ringStart, ringLine, ringEnd, false);
      makeDraggable(ringEnd, ringLine, ringStart, false);
    };
  </script>
</body>
</html>